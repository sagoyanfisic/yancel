name: Fetch Config from AWS

on:
  # Manual
  workflow_dispatch:

  # Autom√°tico cada 6 horas (opcional)
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        if: ${{ secrets.AWS_ACCESS_KEY_ID != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Fetch configuration from AWS App Config
        if: ${{ secrets.AWS_ACCESS_KEY_ID != '' }}
        run: |
          # Obtener configuraci√≥n
          aws appconfig get-configuration \
            --application "${{ secrets.AWS_APPCONFIG_APPLICATION_ID }}" \
            --environment "${{ secrets.AWS_APPCONFIG_ENVIRONMENT_ID }}" \
            --configuration "${{ secrets.AWS_APPCONFIG_CONFIGURATION_PROFILE_ID }}" \
            --client-id "github-actions-$(date +%s)" \
            config.json || echo "{}" > config.json

          echo "üìã Configuraci√≥n obtenida:"
          cat config.json

      - name: Apply configuration
        run: |
          chmod +x .github/scripts/apply-config.sh
          .github/scripts/apply-config.sh || echo "‚ö†Ô∏è No se aplic√≥ configuraci√≥n"

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          git add -A

          if git diff --staged --quiet; then
            echo "‚úÖ No hay cambios para commitear"
          else
            git commit -m "chore: update config from AWS App Config [skip ci]"
            git push
            echo "‚úÖ Configuraci√≥n actualizada y pusheada"

            # Trigger deploy workflow
            echo "üöÄ Triggering deploy..."
            curl -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/dispatches \
              -d '{"ref":"main"}'
          fi
