name: Fetch Config from AWS

on:
  # Manual
  workflow_dispatch:

  # Autom谩tico cada 6 horas (opcional)
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: write

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}

      - name: Fetch configuration from AWS App Config
        run: |
          echo " Obteniendo 煤ltima versi贸n de configuraci贸n..."

          # Obtener la versi贸n m谩s reciente
          VERSION_NUMBER=$(aws appconfig list-hosted-configuration-versions \
            --application-id "${{ secrets.AWS_APPCONFIG_APPLICATION_ID }}" \
            --configuration-profile-id "${{ secrets.AWS_APPCONFIG_CONFIGURATION_PROFILE_ID }}" \
            --query "Items[0].VersionNumber" \
            --output text)

          echo "Versi贸n m谩s reciente: $VERSION_NUMBER"

          # Descargar la configuraci贸n
          aws appconfig get-hosted-configuration-version \
            --application-id "${{ secrets.AWS_APPCONFIG_APPLICATION_ID }}" \
            --configuration-profile-id "${{ secrets.AWS_APPCONFIG_CONFIGURATION_PROFILE_ID }}" \
            --version-number "$VERSION_NUMBER" \
            config.json

          echo " Configuraci贸n obtenida:"
          cat config.json

      - name: Apply configuration
        run: |
          chmod +x .github/scripts/apply-config.sh
          .github/scripts/apply-config.sh || echo "No se aplic贸 configuraci贸n"

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          git add -A

          if git diff --staged --quiet; then
            echo "No hay cambios para commitear"
          else
            git commit -m "chore: update config from AWS App Config [skip ci]"
            git push
            echo "Configuraci贸n actualizada y pusheada"
          fi

      - name: Trigger deploy workflow
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: 'main'
            })
